# CausalKnowledgeTrace: Interactive DAG Visualization and Causal Knowledge Graph Generation

CausalKnowledgeTrace (CKT) automates causal knowledge graph generation from biomedical literature. The system extracts causal relationships from SemMedDB, a database of semantic predications derived from PubMed abstracts.

CKT has two main components. A Python engine handles graph construction and causal identification algorithms. A Shiny web application provides interactive visualization and user configuration.

Users specify an exposure and outcome of interest. They can constrain the search by publication year, causal predicate type, and minimum number of supporting articles per relationship. CKT constructs initial partially directed acyclic graphs (PDAGs) representing causal structures between biomedical concepts. Users then edit these graphs interactively to remove unnecessary nodes and edges. CKT can export graphs and evidence from the literature for downstream analysis. 

Additional tools in the furtherAnalysis folder refine the exported graphs. These tools classify variables by their causal role relative to the exposure and outcome. They identify nodes within three causal steps of the exposure or outcome. The tools also remove extraneous variables and detect minimal adjustment sets for unbiased effect estimation. This includes adjustment sets that address butterfly bias, a form of sample selection bias in causal graphs.

The adjustment sets account for confounding while avoiding collider bias and selection bias. This architecture supports systematic causal inference in observational biomedical research. Researchers can explore alternative causal structures and test different assumptions about edge directionality. The tool facilitates hypothesis generation and study design for epidemiological analyses.

Usage instructions (*a veritable work-in-progress*) are available here: [Usage Instructions](https://docs.google.com/document/d/1SOr5PCclzzkw6_R13Swf0NEyNDwJL9FUW2pQY6wafSs/edit?usp=sharing)

## ğŸ“‹ What This Project Does

- **ğŸŒ Interactive Visualization**: Web-based DAG exploration with zoom, pan, and node interaction
- **ğŸ” Graphical Causal Modeling**: Automated assembly of causal relationships from biomedical literature given Concept Unique Identifiers in the Unified Medical Language System, or [UMLS](https://www.nlm.nih.gov/research/umls/index.html), for the Exposure and Outcome of interest
- **ğŸ“Š Evidence Analysis**: PMID-based evidence tracking and strength assessment
- **âš¡ Performance Optimized**: Binary formats, caching, and vectorized operations for large graphs
- **ğŸ¯ Configurable Analysis**: Enter multiple CUIs for the exposure and/or outcome; Examine 1st, 2nd, or 3rd degree relationships
- **ğŸ“ Multiple Formats**: R DAG files, JSON assertions, optimized binary formats

## Key Features

### ğŸŒ Shiny Web Application

- **Interactive Network Visualization**: Explore DAGs with zoom, pan, and node selection capabilities
- **Dynamic Node Information**: Click on nodes to see detailed information and evidence
- **Physics Controls**: Adjust network layout parameters in real-time
- **Statistics Dashboard**: View network statistics and node distributions
- **Color-coded Categories**: Three-category system (Exposure/Outcome/Other) with optimized performance
- **Flexible Data Loading**: Load DAG structures from generated files or upload custom R files
- **Graph Configuration Interface**: Configure parameters for knowledge graph generation
- **Enhanced CUI Search**: Searchable interface for medical concept selection with semantic type information
- **Efficient Loading**: Fast loading for large graphs

### ğŸ Graph Creation Engine

- **Automated Knowledge Graph Generation**: Create causal graphs from SemMedDB biomedical literature
- **Multiple CUI Support**: Handle multiple Concept Unique Identifiers for exposures and outcomes
- **K-hop Analysis**: Configurable relationship depth (1-3 hops) for comprehensive graph traversal
- **Markov Blanket Analysis**: Advanced causal inference with Markov blanket computation
- **Blacklist Filtering**: Filter out generic or unwanted concepts during graph creation
- **Multiple Output Formats**: Generate R DAG objects, JSON assertion files, and optimized binary formats
- **Performance Monitoring**: Detailed timing analysis and execution metrics

## Project Structure

The project is organized into two main components with clear separation of concerns:

```
CausalKnowledgeTrace/
â”œâ”€â”€ README.md                    # This documentation file
â”œâ”€â”€ setup.sh                    # Automated setup script using conda environment
â”œâ”€â”€ run_app.R                    # Enhanced launch script for Shiny application
â”œâ”€â”€ user_input.yaml              # Configuration file (generated by Shiny app)
â”œâ”€â”€ packages.R                   # R package installation script
â”œâ”€â”€ .env                         # Database credentials (create from doc/sample.env)
â”‚
â”œâ”€â”€ doc/                         # Setup and configuration files
â”‚   â”œâ”€â”€ environment.yaml         # Conda environment specification
â”‚   â”œâ”€â”€ requirements.txt         # Python dependencies
â”‚   â”œâ”€â”€ packages.R               # R package installation script
â”‚   â”œâ”€â”€ sample.env               # Sample environment variables template
â”‚   â”œâ”€â”€ filter.sql               # Database filtering queries for generic CUIs
â”‚   â””â”€â”€ create_cui_search_table.sql # CUI search index table creation script
â”‚
â”œâ”€â”€ shiny_app/                   # Shiny Web Application Component
â”‚   â”œâ”€â”€ app.R                    # Main Shiny application file
â”‚   â”œâ”€â”€ dag_data.R               # DAG data configuration file
â”‚   â”œâ”€â”€ modules/                 # Modular Shiny components
â”‚   â”‚   â”œâ”€â”€ dag_visualization.R  # Network visualization module
â”‚   â”‚   â”œâ”€â”€ node_information.R   # Node information display module
â”‚   â”‚   â”œâ”€â”€ statistics.R         # Statistics and analytics module
â”‚   â”‚   â”œâ”€â”€ data_upload.R        # Data loading and file management
â”‚   â”‚   â”œâ”€â”€ causal_analysis.R    # Causal analysis functionality
â”‚   â”‚   â””â”€â”€ graph_cache.R        # Graph caching system
â”‚   â”œâ”€â”€ server/                  # Server-side logic modules
â”‚   â”œâ”€â”€ ui/                      # UI component modules
â”‚   â””â”€â”€ utils/                   # Utility functions
â”‚
â”œâ”€â”€ furtherAnalysis/             # Analytic code and features that haven't been worked into the main body of code
â”‚   â”œâ”€â”€ classifyVariables.R      # Classifies each variable by its causal role, e.g., confounder, collider, mediator, IV, and the like.
â”‚   â”œâ”€â”€ cleanByRemovingLeaves.R  # Removes leaves (singly-connected nodes) from the causal graph from initial search
â”‚   â”œâ”€â”€ cleanButterflyReport-CausalGraph.R    # code for identifying minimally sufficient adjustment sets in context of butterfly bias 
â”‚   â”œâ”€â”€ cleanButterflyReport-CausalGraph_compiled.R #compiled version of above
â”‚   â”œâ”€â”€ mBiasReport-CausalGraph.R# identifying variables implicated in M-bias from causal graph
â”‚   â””â”€â”€ utils/                   # Utility functions
â”‚
â””â”€â”€ graph_creation/              # Graph Creation Engine Component
    â”œâ”€â”€ pushkin.py               # Main entry point (delegates to cli_interface.py)
    â”œâ”€â”€ cli_interface.py         # Command line interface and argument parsing
    â”œâ”€â”€ analysis_core.py         # Core analysis classes (GraphAnalyzer, MarkovBlanketAnalyzer)
    â”œâ”€â”€ config_models.py         # Configuration models and validation
    â”œâ”€â”€ database_operations.py   # Database connection and query operations
    â”œâ”€â”€ graph_operations.py      # Graph construction and manipulation
    â”œâ”€â”€ markov_blanket.py        # Markov blanket computation algorithms
    â”œâ”€â”€ post_process_optimization.py # File optimization (disabled)
    â”œâ”€â”€ config.py                # Backward compatibility wrapper
    â”œâ”€â”€ consolidation.py         # Graph consolidation utilities
    â”œâ”€â”€ SemDAGconsolidator.py    # SemMedDB DAG consolidation
    â”œâ”€â”€ example/                 # Example scripts and configurations
    â”‚   â”œâ”€â”€ run_pushkin.sh       # Complete pipeline execution script
    â”‚   â””â”€â”€ run_consolidation.sh # Consolidation-only script
    â”œâ”€â”€ result/                  # Generated output files
    â”‚   â”œâ”€â”€ MarkovBlanket_Union.R
    â”‚   â”œâ”€â”€ degree_X.R           # X = K-hops value (1, 2, or 3)
    â”‚   â”œâ”€â”€ causal_assertions_X.json
    â”‚   â””â”€â”€ performance_metrics.json
    â””â”€â”€ output/                  # Alternative output directory
```

## Prerequisites

### System Requirements

- **Git**: Version control system (required for cloning the repository)
- **PostgreSQL** database with modified SemMEDdb data (for graph creation) in postgres
- **Conda/Miniconda**: For environment management (required)
- **Python** (version 3.11 or higher)
- **R** (version 4.0 or higher): Download from [https://cran.r-project.org/](https://cran.r-project.org/)

### Database Requirements

- PostgreSQL database with SemMedDB schema
- Database connection parameters (host, port, username, password, database name)
- **CUI Search Index Table**: Automatically created by the application on first use

## Installation

### Step 1: Get the Repository

#### Option 1: Download as ZIP (Quick Start)

You can download the repository directly from GitHub (without installing _Git_):

**Download Link**: [Download ZIP from GitHub](https://github.com/unmtransinfo/CausalKnowledgeTrace/archive/refs/heads/main.zip)

Extract the ZIP file and navigate to the extracted directory.

#### Option 2: Clone with Git (Recommended)

Installing Git is recommended as it allows you to easily pull future updates to the project.

**Installation Guide**

_Git_ is a version control system that makes updating the software simple. If _Git_ is not already installed on your system, follow these instructions:: [_Git_ Installation Instructions](https://chatgpt.com/share/69249639-630c-800e-9936-7d052643edb7)

After installation, verify that _Git_ is installed correctly:

```bash
git --version
```

Clone the repository:

```bash
git clone git@github.com:unmtransinfo/CausalKnowledgeTrace.git
cd CausalKnowledgeTrace
```

To get future updates, simply run:

```bash
git pull origin main
```

### Step 2: Install PostgreSQL

PostgreSQL is required for storing and querying the SemMedDB data. If you don't have PostgreSQL installed, please follow the installation instructions:

**Installation Guide**: [PostgreSQL Installation Instructions](https://chatgpt.com/share/692494d4-269c-800e-a5a1-96a9e469670b)

After installation, verify that PostgreSQL is installed correctly:

```bash
psql --version
```

### Step 3: PostgreSQL Database Setup for SemMedDB

#### Database Download

We created a modified version of [SemMedDB](https://skr3.nlm.nih.gov/SemMedDB/) that is available in PostgreSQL format.

**Download Link**: Download the `causalehr_backup.tar.gz` file from OneDrive :https://unmm-my.sharepoint.com/:u:/g/personal/rajeshupadhayaya_unm_edu/ESO2UPECVk5Ku3JRSClPytMBngCV_0QN8-cA-zQRjaYogg?e=YolDZH

**Note**: The database file is approximately 25GB in size, so the download may take several minutes depending on your internet connection.

#### Database Setup Instructions

**Prerequisites:**

- PostgreSQL must be installed on your system (see Step 1 above)
- Sufficient disk space (at least 50GB recommended for extraction and setup)

**Create the Database:**

Replace `<username>` with your actual PostgreSQL username.

```bash
tar -xzf causalehr_backup.tar.gz
createdb -U <username> -h localhost causalehr
pg_restore -d causalehr -U <username> causalehr_backup/
```

**Note**: The CUI search index table is automatically created by the application on first use, so no additional setup is required.

### Step 4: Install Miniconda and Setup Environment

This project requires Conda for environment management. If you don't have Conda/Miniconda installed, please follow the official installation guide:

**Installation Guide**: [https://www.anaconda.com/docs/getting-started/miniconda/install](https://www.anaconda.com/docs/getting-started/miniconda/install)

After installation, verify that conda is installed correctly:

```bash
conda --version
conda info
```

#### Setup Steps

Once Miniconda is installed, follow these steps to set up the project environment:

```bash
# 1. Setup environment configuration
cp doc/sample.env .env
# Edit .env with your database credentials

# 2. Create conda environment from the YAML file
conda env create -f doc/environment.yaml

# 3. Activate the environment
conda activate causalknowledgetrace

# 4. Update environment with Python dependencies
pip install -r doc/requirements.txt

# 5. Install R packages
Rscript doc/packages.R
```

**Note**: Make sure R is installed on your system before running the R package installation script.

### Step 5: Database Configuration

Before running graph creation, you need to configure your database connection:

```bash
# Copy the sample environment file
cp doc/sample.env .env

# Edit the .env file with your database credentials
nano .env  # or use your preferred editor
```

The `.env` file should contain:

```bash
# Database Configuration
DB_HOST=localhost
DB_PORT=5432
DB_USER=your_username
DB_PASSWORD=your_password
DB_NAME=your_database_name
DB_SCHEMA=causalehr
```

**Important**:

- Replace the placeholder values with your actual database credentials
- The `.env` file is ignored by git for security (contains sensitive information)
- Make sure your database contains the SemMedDB schema with causalpredication table

### Step 6: Run the Application

Once all the prerequisites are installed and configured, you can launch the Shiny web application:

```bash
# Make sure you're in the project directory and the conda environment is activated
conda activate causalknowledgetrace

# Run the Shiny application
Rscript run_app.R
```

The application will start and open in your default web browser. If it doesn't open automatically, look for the URL in the terminal output (typically `http://127.0.0.1:XXXX` where XXXX is the port number).

**Note**: The first time you run the application, it may take a few moments to initialize the database connections and create necessary index tables.

## CUI Search Functionality

### Enhanced Medical Concept Search

The application includes an advanced CUI (Concept Unique Identifier) search system that provides an intuitive interface for selecting medical concepts:

#### How to Use

Type at least 3 characters and press Enter to search. Click on search results to select CUIs, or manually enter them in the format C followed by 7 digits (e.g., C0020538). Selected CUIs appear as a comma-separated list that can be edited directly.
