# CausalKnowledgeTrace: Interactive DAG Visualization and Knowledge Graph Generation

This project provides a comprehensive system for interactive visualization of Directed Acyclic Graphs (DAGs) and automated knowledge graph generation from biomedical literature. The system consists of two main components: a Shiny web application for visualization and configuration, and a Python-based graph creation engine.

## Features

### Shiny Web Application
- **Interactive Network Visualization**: Explore DAGs with zoom, pan, and node selection capabilities
- **Dynamic Node Information**: Click on nodes to see detailed information
- **Physics Controls**: Adjust network layout parameters in real-time
- **Statistics Dashboard**: View network statistics and node distributions
- **Color-coded Categories**: Automatically categorize and color nodes
- **Flexible Data Loading**: Load any DAG structure from external R files
- **Graph Configuration Interface**: Configure parameters for knowledge graph generation

### Graph Creation Engine
- **Automated Knowledge Graph Generation**: Create causal graphs from biomedical literature
- **SemMedDB Integration**: Query and process semantic predications from SemMedDB
- **Configurable Parameters**: Customize exposure/outcome CUIs, thresholds, and filters
- **Multiple Output Formats**: Generate R DAG objects and JSON assertion files
- **Performance Monitoring**: Track execution times and generate performance metrics

## Project Structure

The project is organized into two main components with clear separation of concerns:

```
CausalKnowledgeTrace/
├── README.md                    # This documentation file
├── run_app.R                    # Launch script for Shiny application
├── run_graph_creation.py        # Launch script for graph creation
├── user_input.yaml              # Configuration file (generated by Shiny app)
├── nohup.out                    # Log file
│
├── shiny_app/                   # Shiny Web Application Component
│   ├── app.R                    # Main Shiny application file
│   ├── dag_data.R               # DAG data configuration file
│   ├── modules/                 # Modular Shiny components
│   │   ├── dag_visualization.R  # Network visualization module
│   │   ├── node_information.R   # Node information display module
│   │   ├── statistics.R         # Statistics and analytics module
│   │   ├── data_upload.R        # Data loading and file management
│   │   ├── graph_config_module.R # Graph configuration interface
│   │   ├── validate_modules.R   # Input validation functions
│   │   └── test_graph_config_module.R # Testing utilities
│   └── www/                     # Static web assets (CSS, JS, images)
│
└── graph_creation/              # Graph Creation Engine Component
    ├── config.py                # Configuration and database operations
    ├── pushkin.py               # Main graph generation script
    ├── consolidation.py         # Graph consolidation utilities
    ├── SemDAGconsolidator.py    # SemMedDB DAG consolidation
    ├── example/                 # Example scripts and configurations
    │   ├── run_consolidation.sh
    │   └── run_pushkin.sh
    └── result/                  # Generated output files
        ├── MarkovBlanket_Union.R
        ├── degree_X.R               # X = K-hops value (1, 2, or 3)
        ├── causal_assertions.json
        ├── performance_metrics.json
        └── run_configuration.json
```

## Prerequisites

### For Shiny Application
- **R** (version 4.0 or higher): Download from [https://cran.r-project.org/](https://cran.r-project.org/)
- **RStudio** (recommended): Download from [https://www.rstudio.com/](https://www.rstudio.com/)

### For Graph Creation Engine
- **Python** (version 3.8 or higher)
- **PostgreSQL** database with SemMedDB data
- Required Python packages (see requirements below)

## Installation

### R Package Installation

Install the required R packages by running the following commands in your R console:

```r
# Install required packages
install.packages(c(
    "shiny",
    "shinydashboard",
    "visNetwork",
    "dplyr",
    "DT"
))

# Optional packages for advanced DAG processing
install.packages(c(
    "SEMgraph",
    "dagitty",
    "igraph"
))
```

**Note**: The application will work with basic functionality even if `SEMgraph`, `dagitty`, and `igraph` are not installed, but these packages provide enhanced DAG processing capabilities.

### Python Package Installation

For the graph creation engine, install the required Python packages:

```bash
# Install required packages
pip install psycopg2-binary pyyaml pandas numpy

# Or if you have a requirements.txt file:
pip install -r requirements.txt
```

## Quick Start

### Running the Shiny Application

1. **Navigate to the project directory**:
   ```bash
   cd /path/to/CausalKnowledgeTrace
   ```

2. **Launch the Shiny application** (choose one method):

   **Method 1: Enhanced Launch Script (Recommended)**
   ```
   Rscript run_app.R
   ```

3. **Access the application**:
   - The app will automatically open in your browser
   - Look for the complete URL in the console output (e.g., `http://127.0.0.1:3838`)
   - If the browser doesn't open automatically, copy and paste the URL manually

### Running the Graph Creation Engine

1. **Configure parameters** using the Shiny app's "Graph Configuration" tab
2. **Run the graph creation**:
   ```bash
   # Using the launch script 
   python run_graph_creation.py

   # Or directly
   cd graph_creation
   python pushkin.py --yaml-config ../user_input.yaml
   ```

### Configuration Flow

1. **Configure Parameters**: Use the Shiny app's "Graph Configuration" tab to set:
   - Exposure and Outcome CUIs
   - Squelch Threshold (minimum unique pmids)
   - Publication year cutoff

   - K-hops parameter
   - SemMedDB version

2. **Save Configuration**: Click "Create Graph" to save parameters to `user_input.yaml`

3. **Generate Graph**: Run the graph creation engine to process the configuration and generate graphs

4. **Automatic Integration**: Generated graphs are automatically saved to `graph_creation/result/` directory

5. **Visualize Results**: Use the Shiny app's "Data Upload" tab to load and visualize the generated graphs

### YAML Configuration Format

The `user_input.yaml` file uses the following structure:

```yaml
exposure_cuis:
  - C0011849
  - C0020538
outcome_cuis:
  - C0027051
  - C0038454
exposure_name: ~  # Optional: custom name for exposure
outcome_name: ~   # Optional: custom name for outcome
min_pmids: 50
pub_year_cutoff: 2010
k_hops: 1
predication_type:  # List format (recommended)
  - CAUSES
  - INTERACTS_WITH
SemMedDBD_version: heuristic
```

**Predication Types**: The system supports both list format (recommended) and comma-separated string format for backward compatibility:
- **List format** (recommended): `predication_type: [CAUSES, TREATS, PREVENTS]`
- **String format** (legacy): `predication_type: "CAUSES,TREATS,PREVENTS"`

Common predication types include: CAUSES, TREATS, PREVENTS, INTERACTS_WITH, AFFECTS, ASSOCIATED_WITH, PREDISPOSES, COMPLICATES, and others.

## Data Configuration

### Using Your Own DAG Files

The application now provides a flexible file loading system through the user interface:

#### Method 1: Use Generated Graph Files (Recommended)

1. **Generate graphs** using the graph creation engine (Python component)
2. **Generated files** are automatically saved to `graph_creation/result/` directory
3. **Go to the "Data Upload" tab** in the Shiny app
4. **Click "Refresh File List"** to scan for available files
5. **Select your generated file** (e.g., `degree_1.R`, `degree_2.R`, `degree_3.R`, `MarkovBlanket_Union.R`) from the dropdown
6. **Click "Load Selected DAG"**

#### Method 2: Upload Through the Interface

1. **Go to the "Data Upload" tab** in the app
2. **Use the file upload interface** to select your R file
3. **Click "Upload & Load"** to upload and immediately load the DAG

#### DAG File Format

Your R file should contain a dagitty graph definition with the variable name `g`:

```r
# Your DAG file (e.g., graph.R)
g <- dagitty('dag {
    Variable1 [exposure]
    Variable2 [outcome]
    Variable3
    Variable4
    # ... as many variables as needed
    
    Variable1 -> Variable2
    Variable2 -> Variable3
    Variable3 -> Variable4
    # ... as many relationships as needed
}')
```

#### Auto-Detection Features

The application automatically:
- **Scans for DAG files** in the app directory
- **Validates file contents** for dagitty syntax
- **Loads default files** (graph.R, my_dag.R, dag.R) if available
- **Provides status updates** on the Data Upload tab

### Using the Large Graph Example

To use the large graph you provided:

1. **Replace the DAG definition** in `dag_data.R`:
   ```r
   g <- dagitty('dag {
   Hypertension [exposure]
   Alzheimers_Disease [outcome]
   Surgical_margins
   PeptidylDipeptidase_A
   # ... paste all your nodes here
   
   Triglycerides -> Hypertensive_disease
   Mutation -> Neurodegenerative_Disorders
   # ... paste all your edges here
   }')
   ```

2. **The application will automatically**:
   - Process all nodes and edges with optimized performance
   - Categorize nodes into three simple categories:
     - **Exposure**: Variables marked as [exposure] in the DAG
     - **Outcome**: Variables marked as [outcome] in the DAG
     - **Other**: All other variables in the DAG

3. **Performance optimizations for large graphs**:
   - Smaller font sizes for better visibility
   - Thinner edge lines
   - Efficient color assignment
   - Progress indicators during processing

### Node Categories and Colors

The application uses an optimized three-category system:

- **Exposure** (Bright Orange-Red): Variables marked as [exposure] in the DAG
- **Outcome** (Bright Blue): Variables marked as [outcome] in the DAG
- **Other** (Gray): All other variables in the DAG

This system uses vectorized operations for fast processing of large graphs while maintaining the original color scheme.

## Installation and Running

1. **Download the files** to your local machine:
   - `app.R` (main application)
   - `dag_data.R` (data configuration)

2. **Set working directory** to the folder containing both files

3. **Run the application** using one of these methods:

   **Method 1: Using RStudio**
   ```r
   # Open app.R in RStudio
   # Click the "Run App" button
   ```

   **Method 2: Using R Console**
   ```r
   # Set working directory to the app folder
   setwd("path/to/your/app/folder")
   
   # Run the app
   shiny::runApp("app.R")
   ```

   **Method 3: Direct execution**
   ```r
   # If you're in the correct directory
   source("app.R")
   ```

4. **Access the application** - The app will open in your browser at `http://127.0.0.1:XXXX`

## Usage Instructions

### Main Features

1. **DAG Visualization Tab**
   - Interactive network diagram with your DAG structure
   - Drag nodes to reposition them
   - Zoom with mouse wheel
   - Click nodes to select and view details
   - Adjust physics parameters with sliders
   - **Reload DAG Data** button to refresh from dag_data.R
   - **Create Graph** button to navigate to graph configuration

2. **Node Information Tab**
   - Detailed information about selected nodes
   - Searchable table of all nodes
   - Node metadata and properties

3. **Statistics Tab**
   - Network statistics (nodes, edges, groups)
   - Node distribution charts
   - DAG structure information

4. **Data Upload Tab**
   - Instructions for modifying DAG data
   - Example data structure
   - Guidelines for creating custom DAGs

5. **Graph Configuration Tab**
   - Configure parameters for knowledge graph generation
   - Set exposure and outcome CUIs (Concept Unique Identifiers)
   - Adjust minimum PMIDs, publication year cutoff, and other parameters
   - Save configuration to user_input.yaml file
   - Validate input parameters with real-time feedback

### Controls

- **Physics Strength**: Adjust gravitational force between nodes (-500 to -50)
- **Spring Length**: Control preferred distance between connected nodes (100 to 400)
- **Reset Physics**: Return to default layout settings
- **Reload DAG Data**: Refresh data from dag_data.R file

### Customizing Your DAG

1. **Edit dag_data.R** with your own data structure
2. **Click "Reload DAG Data"** in the application
3. **No need to restart** the application

#### Node Categories and Colors

The application uses an optimized three-category system:

- **Exposure** (Bright Orange-Red): Variables marked as [exposure] in the DAG
- **Outcome** (Bright Blue): Variables marked as [outcome] in the DAG
- **Other** (Gray): All other variables in the DAG

The categorization uses vectorized operations for optimal performance with large graphs.

## Advanced Usage

### Creating DAGs from dagitty

If you have a dagitty object, you can use the provided helper function:

```r
# In your dag_data.R file
library(dagitty)

# Define your DAG
g <- dagitty('dag {
    X [exposure]
    Y [outcome]
    Z
    X -> Z -> Y
}')

# Use the helper function
network_data <- create_network_data(g)
dag_nodes <- network_data$nodes
dag_edges <- network_data$edges
dag_object <- g
```

### Performance Optimization

Node categorization has been optimized using vectorized operations instead of individual node processing. This provides the same visual categorization (Exposure/Outcome/Other) with dramatically improved performance for large graphs.

The key optimization:
- **Before**: Individual processing of each node using `sapply(nodes, categorize_node)`
- **After**: Vectorized operations using `nodes$group[nodes$id %in% exposures] <- "Exposure"`

This maintains the original color scheme while providing near-instant processing even for graphs with thousands of nodes.

## Troubleshooting

### Common Issues

1. **"Could not load dag_data.R"**
   - Ensure `dag_data.R` is in the same directory as `app.R`
   - Check that the file contains `dag_nodes` and `dag_edges` variables
   - Verify the data frame structures match the requirements

2. **"Missing node/edge columns"**
   - Check that your data frames have the required columns
   - The application will attempt to add missing optional columns with defaults

3. **Network not displaying**
   - Ensure `dag_edges` has 'from' and 'to' columns
   - Check that node IDs in edges match those in nodes
   - Verify there are no circular references

4. **Package installation errors**
   - Install packages one by one to identify issues
   - SEMgraph, dagitty, and igraph are optional for basic functionality

### Data Validation

The application includes built-in data validation that will:
- Check for required columns
- Add missing optional columns with defaults
- Display warnings for data issues
- Provide fallback data if loading fails

## Examples

### Simple Three-Node DAG

```r
# Example using dagitty format (recommended)
g <- dagitty('dag {
    Variable_A [exposure]
    Variable_B
    Variable_C [outcome]

    Variable_A -> Variable_B
    Variable_B -> Variable_C
}')

# The application will automatically categorize and color nodes:
# - Variable_A: Exposure (Orange-Red #FF4500)
# - Variable_C: Outcome (Blue #0066CC)
# - Variable_B: Other (Gray #808080)
```

### Complex Medical DAG

```r
# Example medical DAG using dagitty format
g <- dagitty('dag {
    Hypertension [exposure]
    Diabetes
    Stroke [outcome]
    Age
    BMI

    Age -> Hypertension
    BMI -> Diabetes
    Hypertension -> Stroke
    Diabetes -> Stroke
}')

# The application will automatically categorize and color nodes:
# - Hypertension: Exposure (Orange-Red #FF4500)
# - Stroke: Outcome (Blue #0066CC)
# - Diabetes, Age, BMI: Other (Gray #808080)
```

## Support

For issues or questions:
1. Check that all required files are in the correct directory
2. Verify your dag_data.R file structure matches the requirements
3. Check the R console for detailed error messages
4. Use the "Reload DAG Data" button after making changes

## License

This application is provided as-is for educational and research purposes.